This document describes the changes that are proposed in the L2 Plugin and the L2 Agent for OpenStack Neutron in order to enable distributed virtual router functionality at the L2 layer.


Design Goals for L2 in DVR

There are set of goals that went into the design of the set of rules in OVS to enable distributed virtual routing functionality at the L2 layer. They are the following:

1. The rules should enable communication between tenant VMs on different networks, via a distributed router hosted in the compute node.

2. Any given distributed router instance may reside on an all the Compute Nodes and will be responsible for routing packets generated by VMs co-residing on the same node.

3. A given distributed router instance is either hosted in the Compute Node as DVR (or) as normal router on the Network Node, but never simultaneously in both the nodes.

4. The rules should be such that the existing OpenVswitch infrastructure in OpenStack Neutron can be used to accomplish distributed routing.

5. Should use lesser MAC Address per compute node and continue to preserve L2 isolation for routed packets by distributed routers.

6. Should ensure enablement of North-South routing, which indicates access to external network by the VMs directly.

7. Should embrace FWaaS Service to be operational even with distributed routing enabled on DVR interfaces.

8. MAC timeouts and ARP timeouts of any element (bridges) inside the nodes in the cloud, should not affect operation of DVR

9. The rules must ensure that multi-tenant isolation is intact even when Overlapping IP Addresses is enabled in the cloud.

10. The rules must ensure that multi-tenant isolation is intact even when Overlapping MAC Addresses are enabled in the cloud (By overlapping MAC Addresses, what is meant here is that MAC Addresses across different networks could be the same)


How Distributed Routing Works

In order to accomplish distributed routing, both the L3 and L2 Agent work will need to work hand-in-hand inside the Compute Node. Today the L3 Agent runs in Network Node, but with this DVR proposal, the L3 Agent will run in Compute Nodes as well. The L2 Agent on compute nodes will continue as is today but will work in an enhanced mode called the ‘DVR Mode’ where the L2 Agents will be additionally responsible for managing (adding/removing) OVS rules in order to accomplish distributed routing.

The following is a sample topology used to illustrate how distributed routing is accomplished. 
